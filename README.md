# Оглавление

- [Быстрый старт](#быстрый-старт)
- [Настройка](#настройка)
  - [Настройки сервера](#настройки-сервера)
  - [Настройки загрузки](#настройки-загрузки)
  - [Настройки сессии](#настройки-сессии)
  - [Настройки шифрования](#настройки-шифрования)
- [Работа с файлами](#работа-с-файлами)
  - [filesSave](#filessave)
  - [filesRename](#filesrename)
  - [filesMaxSize](#filesmaxsize)
  - [filesAllowTypes](#filesallowtypes)
  - [filesIsImage](#filesisimage)
  - [filesImageMetadata](#filesimagemetadata)
  - [filesImageResize](#filesimageresize)
  - [filesImageOversize](#filesimageoversize)
  - [convertToWebp](#converttowebp)
  - [filesImageConvert](#filesimageconvert)
  - [Интерфейс файла](#интерфейс-файла)
- [Тестирование](#тестирование)
- [Лицензия](#лицензия)

# Быстрый старт

Выполните клонирование:

```shell script
git clone https://github.com/fwmakc/server-files
cd server-files
yarn
```

Для запуска в режиме разработки:

```shell script
yarn dev
```

Для сборки:

```shell script
yarn build
```

Для запуска без **pm2**, выполните:

```shell script
yarn start:prod
```

Мы рекомендуем использовать менеджер процессов **pm2**.

Запуск процесса:

```shell script
pm2 start dist/main.js --name fileserver
```

Перезапуск процесса:

```shell script
pm2 reload fileserver
```

Остановка процесса:

```shell script
pm2 stop fileserver
```

Мониторинг процессов:

```shell script
pm2 monit
```

Просмотр логов:

```shell script
pm2 logs fileserver --lines 1000
```

[^ к оглавлению](#оглавление)

# Настройка

Настройка бэка производится переменными окружения, которые лежат в файле **.env**. Этот файл небезопасно хранить в репозитории, поэтому мы предлагаем файл с примерным содержанием настроек **.env.example**.

Переименуйте или скопируйте файл **.env.example** в **.env**, а затем настройте его под ваш проект.

```shell script
cp .env.example .env
```

Некоторые настройки предусматривают значения вкл/выкл. В этом случае для включения можно использовать значение **true**, а для выключения оставить поле пустым.

Этот файл условно разделен на несколько частей.

[^ к оглавлению](#оглавление)

## Настройки сервера

- NODE_ENV - задает режим работы: **development** или **production**,
- IP - адрес, на котором будет запускаться бэк, по-умолчанию (если не указан) **localhost**,
- PORT - порт, на котором будет запускаться бэк, по-умолчанию **5000**,
- PREFIX - здесь вы можете задать глобальный префикс, например **api** и тогда бэк будет доступен по адресу **http://localhost/api**,

[^ к оглавлению](#оглавление)

## Настройки загрузки

- UPLOADS_PATH - каталог для загрузки файлов в корневом каталоге, по-умолчанию **/public/uploads**,
- UPLOADS_URL - путь для формирования ссылки к загруженному файлу в корневом каталоге, по-умолчанию **/uploads**,
- UPLOADS_ALLOW_TYPES - разрешенные для загрузки mime-типы файлов, перечисляются через точку с запятой, по-умолчанию пусто, т.е. разрешены любые типы,
- UPLOADS_MAX_SIZE - максимально допустимый размер файла для загрузки, в байтах, если не задано, то без ограничений, по-умолчанию **1048576**, т.е. **1 МБ**,
- UPLOADS_IMAGE_MAX_WIDTH - максимально допустимая ширина загружаемого изображения, при превышении изображение будет сжато до этих размеров, если не задано, то без ограничений, по-умолчанию **3840**,
- UPLOADS_IMAGE_MAX_HEIGHT - максимально допустимая высота загружаемого изображения, при превышении изображение будет сжато до этих размеров, если не задано, то без ограничений, по-умолчанию **2160**.

[^ к оглавлению](#оглавление)

## Настройки сессии

- SESSION_SECRET - здесь должна быть любая строка из случайного количества символов, которая является ключом для механизма сессий,
- SESSION_EXPIRES=2592000 - срок жизни сессии в секундах. Желательно, чтобы он был не больше, чем **JWT_REFRESH_EXPIRES**. По-умолчанию равен 30 дням.

[^ к оглавлению](#оглавление)

## Настройки шифрования

- SECURE_SECRET - ключ шифрования защищенных методов, строка из символов произвольной длины,
- SECURE_EXPIRES - срок действия токена шифрования в секундах,
- SECURE_SIMPLE - токен для простой защиты защищенных методов.

# Работа с файлами

Загрузка файлов возможна только через контроллер.

Контроллер **files** реализует только один метод **upload**, который поддерживает query-параметры **options**:

- options.convert - true/false, разрешает конвертацию изображений в формат **webp**,
- options.folder - строка, этот параметр нужен для того, чтобы загружать файл во вложенные каталоги,
- options.rename - true/false, разрешает переименовать файл в **uuid**,
- options.replace - true/false, разрешает перезаписать файл, если такой уже есть на сервере,
- options.resize - true/false, разрешает уменьшать изображение, если оно превышает установленные допустимые размеры по ширине и высоте.

Изначальный каталог для загрузки файлов задается в **.env** файле, в параметре **UPLOADS_PATH**.

Метод позволяет загружать несколько файлов одновременно, устанавливать максимально допустимый размер и разрешенные типы файлов.

Кроме того, метод конвертирует изображения в формат **webp**, ужимая большие до заданных пределов с сохранением соотношения сторон.

> для работы с изображениями используется библиотека **sharp**.

В качестве результата выдается массив с расширенной информацией о каждом файле:

- url - ссылка на файл,
- originalname - имя файла,
- mimetype - mime-тип,
- size - размер в байтах.

Для работы с файлами, вы можете построить свои контроллеры, используя существующие сервисные функции.

[^ к оглавлению](#оглавление)

## filesSave

Сохраняет файлы в заданный вложенный каталог.

В случае ошибки при записи файла, выбрасывает исключение.

Принимает аргументы:

- массив экземпляров интерфейса,
- вложенный каталог (строка), необязательный.

Возвращает массив экземпляров интерфейса.

[^ к оглавлению](#оглавление)

## filesRename

Дает файлу новое имя в виде случайно сгенерированного набора символов по стандарту **uuid** версии 4.

Принимает аргументы:

- экземпляр интерфейса,
- расширение (строка), необязательный.

Возвращает экземпляр интерфейса.

[^ к оглавлению](#оглавление)

## filesMaxSize

Вычисляет, соответствует ли файл заданному размеру.

Если размер не указан или равен 0, то файл всегда будет соответствовать.

Принимает аргументы:

- экземпляр интерфейса,
- максимальный размер (число), необязательный.

Возвращает true/false.

[^ к оглавлению](#оглавление)

## filesAllowTypes

Вычисляет, соответствует ли файл заданному типу.

Тип может быть указан как один из mime-типов, либо его часть. Можно указать несколько через запятую.

Например:

```
    'jpeg'
    'image/jpeg'
    'image/*'
    'image'
    'jpeg', 'png', 'webp'
    'audio', 'image', 'video'
```

Если тип не указан, то файл всегда будет соответствовать.

Принимает аргументы:

- экземпляр интерфейса,
- типы (строка или массив строк), необязательный.

Возвращает true/false.

[^ к оглавлению](#оглавление)

## filesIsImage

Вычисляет, является ли файл изображением.

Работает по mime-типу файла.

Принимает аргументы:

- экземпляр интерфейса.

Возвращает true/false.

[^ к оглавлению](#оглавление)

## filesImageMetadata

Возвращает метаданные изображения.

Работает через библиотеку **sharp**.

Принимает аргументы:

- буфер.

Возвращает метаданные.

[^ к оглавлению](#оглавление)

## filesImageResize

Меняет размер изображения, ширину и высоту.

В качестве опций можно указать объект:

```
    {
        width,
        height,
        fit,
        position,
        background,
        kernel
    }
```

Работает через библиотеку **sharp**.

Подробнее обо всех параметрах можно узнать в документации на библиотеку.

Принимает аргументы:

- буфер,
- опции.

Возвращает буфер.

[^ к оглавлению](#оглавление)

## filesImageOversize

Меняет размер изображения если оно превышает заданные ширину или высоту.

Сохраняет соотношение сторон.

В качестве опций можно указать объект:

```
    {
        width,
        height
    }
```

Работает через функцию **filesImageResize**.

Принимает аргументы:

- буфер,
- опции.

Возвращает буфер.

[^ к оглавлению](#оглавление)

## convertToWebp

Конвертирует изображение в формат **webp**.

Работает через библиотеку **sharp**.

Принимает аргументы:

- буфер.

Возвращает буфер.

[^ к оглавлению](#оглавление)

## filesImageConvert

Конвертирует все изображения, кроме **svg**, в формат **webp**.

Работает через функцию **convertToWebp**.

Принимает аргументы:

- буфер.

Возвращает экземпляр интерфейса.

[^ к оглавлению](#оглавление)

## Интерфейс файла

Вся работа с файлами ведется через интерфейс, который содержит следующие поля:

- buffer - буфер с содержимым файла, обязательное,
- originalname - имя файла,
- mimetype - mime-тип файла,
- url - ссылка на файл, необязательное,
- size - размер в байтах, необязательное,
- width - ширина, только для изображений, необязательное,
- height - высота, только для изображений, необязательное.

Интерфейс создается через конструктор класса, который принимает файл в формате **Express.Multer.File** или экземпляр интерфейса.

[^ к оглавлению](#оглавление)

# Тестирование

Движок тестирования: **jest**.

Используются:

- unit тесты,
- интеграционные тесты (e2e).

Запуск юнит-тестов:

```
yarn test
```

Запуск интеграционных тестов:

```
yarn test:e2e
```

[^ к оглавлению](#оглавление)

# Лицензия

Лицензия MIT, 2025

Для работы использован Nest.js Framework.

Версия 11 и выше.
Под лицензией MIT.
Ссылка: https://github.com/nestjs/nest
Лицензия: https://github.com/nestjs/nest?tab=MIT-1-ov-file#readme
