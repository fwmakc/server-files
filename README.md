# Оглавление

- [Работа с файлами](#работа-с-файлами)
  - [filesSave](#filessave)
  - [filesRename](#filesrename)
  - [filesMaxSize](#filesmaxsize)
  - [filesAllowTypes](#filesallowtypes)
  - [filesIsImage](#filesisimage)
  - [filesImageMetadata](#filesimagemetadata)
  - [filesImageResize](#filesimageresize)
  - [filesImageOversize](#filesimageoversize)
  - [convertToWebp](#converttowebp)
  - [filesImageConvert](#filesimageconvert)
  - [Интерфейс файла](#интерфейс-файла)

# Работа с файлами

Загрузка файлов возможна только через контроллер.

Контроллер **files** реализует только один метод **upload**, который поддерживает query-параметры **options**:

- options.convert - true/false, разрешает конвертацию изображений в формат **webp**,
- options.folder - строка, этот параметр нужен для того, чтобы загружать файл во вложенные каталоги,
- options.rename - true/false, разрешает переименовать файл в **uuid**,
- options.replace - true/false, разрешает перезаписать файл, если такой уже есть на сервере,
- options.resize - true/false, разрешает уменьшать изображение, если оно превышает установленные допустимые размеры по ширине и высоте.

Изначальный каталог для загрузки файлов задается в **.env** файле, в параметре **UPLOADS_PATH**.

Метод позволяет загружать несколько файлов одновременно, устанавливать максимально допустимый размер и разрешенные типы файлов.

Кроме того, метод конвертирует изображения в формат **webp**, ужимая большие до заданных пределов с сохранением соотношения сторон.

> для работы с изображениями используется библиотека **sharp**.

В качестве результата выдается массив с расширенной информацией о каждом файле:

- url - ссылка на файл,
- originalname - имя файла,
- mimetype - mime-тип,
- size - размер в байтах.

Для работы с файлами, вы можете построить свои контроллеры, используя существующие сервисные функции.

[^ к оглавлению](#оглавление)

## filesSave

Сохраняет файлы в заданный вложенный каталог.

В случае ошибки при записи файла, выбрасывает исключение.

Принимает аргументы:

- массив экземпляров интерфейса,
- вложенный каталог (строка), необязательный.

Возвращает массив экземпляров интерфейса.

[^ к оглавлению](#оглавление)

## filesRename

Дает файлу новое имя в виде случайно сгенерированного набора символов по стандарту **uuid** версии 4.

Принимает аргументы:

- экземпляр интерфейса,
- расширение (строка), необязательный.

Возвращает экземпляр интерфейса.

[^ к оглавлению](#оглавление)

## filesMaxSize

Вычисляет, соответствует ли файл заданному размеру.

Если размер не указан или равен 0, то файл всегда будет соответствовать.

Принимает аргументы:

- экземпляр интерфейса,
- максимальный размер (число), необязательный.

Возвращает true/false.

[^ к оглавлению](#оглавление)

## filesAllowTypes

Вычисляет, соответствует ли файл заданному типу.

Тип может быть указан как один из mime-типов, либо его часть, либо массив.

Например:

    'jpeg'
    'image/jpeg'
    'image/*'
    'image'
    ['jpeg', 'png', 'webp']
    ['audio', 'image', 'video']

Если тип не указан, то файл всегда будет соответствовать.

Принимает аргументы:

- экземпляр интерфейса,
- типы (строка или массив строк), необязательный.

Возвращает true/false.

[^ к оглавлению](#оглавление)

## filesIsImage

Вычисляет, является ли файл изображением.

Работает по mime-типу файла.

Принимает аргументы:

- экземпляр интерфейса.

Возвращает true/false.

[^ к оглавлению](#оглавление)

## filesImageMetadata

Возвращает метаданные изображения.

Работает через библиотеку **sharp**.

Принимает аргументы:

- буфер.

Возвращает метаданные.

[^ к оглавлению](#оглавление)

## filesImageResize

Меняет размер изображения, ширину и высоту.

В качестве опций можно указать объект:

    {
        width,
        height,
        fit,
        position,
        background,
        kernel
    }

Работает через библиотеку **sharp**.

Подробнее обо всех параметрах можно узнать в документации на библиотеку.

Принимает аргументы:

- буфер,
- опции.

Возвращает буфер.

[^ к оглавлению](#оглавление)

## filesImageOversize

Меняет размер изображения если оно превышает заданные ширину или высоту.

Сохраняет соотношение сторон.

В качестве опций можно указать объект:

    {
        width,
        height
    }

Работает через функцию **filesImageResize**.

Принимает аргументы:

- буфер,
- опции.

Возвращает буфер.

[^ к оглавлению](#оглавление)

## convertToWebp

Конвертирует изображение в формат **webp**.

Работает через библиотеку **sharp**.

Принимает аргументы:

- буфер.

Возвращает буфер.

[^ к оглавлению](#оглавление)

## filesImageConvert

Конвертирует все изображения, кроме **svg**, в формат **webp**.

Работает через функцию **convertToWebp**.

Принимает аргументы:

- буфер.

Возвращает экземпляр интерфейса.

[^ к оглавлению](#оглавление)

## Интерфейс файла

Вся работа с файлами ведется через интерфейс, который содержит следующие поля:

- buffer - буфер с содержимым файла, обязательное,
- originalname - имя файла,
- mimetype - mime-тип файла,
- url - ссылка на файл, необязательное,
- size - размер в байтах, необязательное,
- width - ширина, только для изображений, необязательное,
- height - высота, только для изображений, необязательное.

Интерфейс создается через конструктор класса, который принимает файл в формате **Express.Multer.File** или экземпляр интерфейса.

[^ к оглавлению](#оглавление)

# Лицензия

Лицензия MIT, 2025

Для работы использован Nest.js Framework.

Версия 11 и выше.
Под лицензией MIT.
Ссылка: https://github.com/nestjs/nest
Лицензия: https://github.com/nestjs/nest?tab=MIT-1-ov-file#readme
